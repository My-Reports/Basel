<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Management Analytics | لوحة التحليل المتقدمة</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator_modern.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        body { background-color: #f8fafc; font-family: 'Tajawal', sans-serif; }
        .chart-card { background: white; border-radius: 1rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); padding: 1.5 circle; transition: transform 0.2s; }
        .chart-card:hover { transform: translateY(-5px); }
        .tabulator { border-radius: 1rem; border: none; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #2563eb; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-6 text-gray-800">

    <div class="max-w-[1400px] mx-auto">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-8 gap-4 bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <div>
                <h1 class="text-3xl font-extrabold text-blue-900">نظام تحليل البيانات الإحصائي</h1>
                <p class="text-gray-500 mt-1">تقارير ذكية لاتخاذ القرارات الإدارية</p>
            </div>
            
            <div class="flex flex-wrap gap-3 items-center w-full lg:w-auto">
                <div class="relative flex-grow lg:flex-grow-0">
                    <input type="text" id="excelUrl" 
                           value="https://github.com/My-Reports/Basel/raw/refs/heads/main/gittest.xlsx" 
                           class="border-2 border-gray-200 p-2 rounded-xl w-full lg:w-80 text-sm focus:border-blue-500 outline-none transition-all">
                </div>
                <button onclick="loadFromUrl()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-blue-200 transition-all">
                    <i class="fas fa-cloud-download-alt"></i> جلب من الرابط
                </button>
                <label class="bg-emerald-600 hover:bg-emerald-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 cursor-pointer shadow-lg shadow-emerald-200 transition-all">
                    <i class="fas fa-file-upload"></i> رفع ملف يدوي
                    <input type="file" id="fileInput" class="hidden" accept=".xlsx, .xls">
                </label>
                <div id="loader" class="loader"></div>
            </div>
        </div>

        <div id="statsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8">
            <div class="chart-card lg:col-span-8">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-chart-bar text-blue-600"></i> تحليل الأداء لكل SKU</h3>
                </div>
                <div id="mainBarChart" class="w-full h-[400px]"></div>
            </div>
            
            <div class="chart-card lg:col-span-4">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-chart-pie text-emerald-600"></i> التوزيع حسب المنطقة</h3>
                </div>
                <div id="mainPieChart" class="w-full h-[400px]"></div>
            </div>

            <div class="chart-card lg:col-span-12">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-chart-line text-purple-600"></i> اتجاه المبيعات الزمني</h3>
                </div>
                <div id="timeSeriesChart" class="w-full h-[350px]"></div>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl border border-gray-100 p-6 overflow-hidden">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <h3 class="font-bold text-xl flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-700 p-2 rounded-lg text-sm">Data</span>
                    جدول البيانات التفصيلي
                </h3>
                <div class="flex gap-2">
                    <button onclick="table.download('xlsx', 'Report.xlsx')" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-bold transition-all">
                        <i class="fas fa-file-excel text-green-600 mr-1"></i> Excel
                    </button>
                    <button onclick="table.download('pdf', 'Report.pdf')" class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-bold transition-all">
                        <i class="fas fa-file-pdf text-red-600 mr-1"></i> PDF
                    </button>
                </div>
            </div>
            <div id="table-container"></div>
        </div>
    </div>

<script>
let table;

// المستمع لتحميل الملف يدوياً
document.getElementById('fileInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        processWorkbook(data);
    };
    reader.readAsArrayBuffer(file);
});

// تشغيل تلقائي
window.onload = loadFromUrl;

async function loadFromUrl() {
    const loader = document.getElementById('loader');
    let url = document.getElementById('excelUrl').value;
    
    // تصحيح روابط GitHub تلقائياً
    if (url.includes("github.com")) {
        url = url.replace("github.com", "raw.githubusercontent.com").replace("/raw/", "/");
    }

    loader.style.display = 'block';
    
    try {
        // تجربة الجلب المباشر ثم استخدام البروكسي كخيار بديل
        let response;
        try {
            response = await fetch(url);
        } catch(e) {
            response = await fetch("https://api.allorigins.win/raw?url=" + encodeURIComponent(url));
        }

        if (!response.ok) throw new Error("فشل الوصول للملف");
        const data = await response.arrayBuffer();
        processWorkbook(data);
    } catch (error) {
        alert("تنبيه: لم نتمكن من جلب الملف من الرابط. يرجى استخدام زر 'رفع ملف يدوي' لتشغيل التحليل.");
    } finally {
        loader.style.display = 'none';
    }
}

function processWorkbook(data) {
    const workbook = XLSX.read(data, {type:"array"});
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const jsonData = XLSX.utils.sheet_to_json(sheet);
    
    if(jsonData.length > 0) {
        renderStats(jsonData);
        renderTable(jsonData);
        renderCharts(jsonData);
    }
}

function renderStats(data) {
    const totalQty = data.reduce((sum, row) => sum + (Number(row.Qty) || 0), 0);
    const totalValue = data.reduce((sum, row) => sum + (Number(row.Value) || 0), 0);
    const avg = (totalValue / data.length).toFixed(1);
    
    const stats = [
        { label: 'إجمالي المبيعات', val: totalValue.toLocaleString(), unit: '$', icon: 'fa-dollar-sign', color: 'blue' },
        { label: 'الكمية المباعة', val: totalQty, unit: 'قطعة', icon: 'fa-box-open', color: 'emerald' },
        { label: 'متوسط الفاتورة', val: avg, unit: '$', icon: 'fa-receipt', color: 'purple' },
        { label: 'عدد العمليات', val: data.length, unit: 'عملية', icon: 'fa-exchange-alt', color: 'orange' }
    ];

    document.getElementById('statsContainer').innerHTML = stats.map(s => `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-50 flex justify-between items-center transition-all hover:shadow-md">
            <div>
                <p class="text-gray-400 text-sm font-bold uppercase tracking-wider">${s.label}</p>
                <h2 class="text-2xl font-black mt-1 text-gray-800">${s.val} <span class="text-sm font-normal text-gray-400">${s.unit}</span></h2>
            </div>
            <div class="h-12 w-12 bg-${s.color}-50 text-${s.color}-600 rounded-xl flex items-center justify-center shadow-inner">
                <i class="fas ${s.icon} fa-lg"></i>
            </div>
        </div>
    `).join('');
}

function renderTable(data) {
    table = new Tabulator("#table-container", {
        data: data,
        layout: "fitColumns",
        pagination: "local",
        paginationSize: 10,
        selectable: true,
        columns: Object.keys(data[0]).map(col => ({
            title: col, field: col, headerFilter: "input",
            hozAlign: typeof data[0][col] === 'number' ? 'center' : 'right'
        }))
    });
}

function renderCharts(data) {
    const config = { responsive: true, displayModeBar: false };
    
    // Bar Chart
    const skus = [...new Set(data.map(d => d.SKU))];
    const vals = skus.map(s => data.filter(d => d.SKU === s).reduce((sum, row) => sum + (Number(row.Value) || 0), 0));
    
    Plotly.newPlot('mainBarChart', [{
        x: skus, y: vals, type: 'bar', 
        marker: { color: 'rgba(37, 99, 235, 0.7)', line: {color: '#2563eb', width: 1.5} }
    }], { margin: {t:10}, font: {family: 'Tajawal'} }, config);

    // Pie Chart
    const cities = {};
    data.forEach(d => cities[d.City] = (cities[d.City] || 0) + (Number(d.Qty) || 0));
    
    Plotly.newPlot('mainPieChart', [{
        labels: Object.keys(cities), values: Object.values(cities),
        type: 'pie', hole: 0.6,
        marker: { colors: ['#0ea5e9', '#10b981', '#f59e0b', '#6366f1', '#ec4899'] }
    }], { margin: {t:10}, showlegend: true, legend: {orientation: 'h'} }, config);

    // Time Series
    const dateField = Object.keys(data[0]).find(k => k.toLowerCase().includes('date'));
    if(dateField) {
        const dates = {};
        data.forEach(d => dates[d[dateField]] = (dates[d[dateField]] || 0) + (Number(d.Value) || 0));
        const sortedDates = Object.keys(dates).sort();
        
        Plotly.newPlot('timeSeriesChart', [{
            x: sortedDates, y: sortedDates.map(d => dates[d]),
            type: 'scatter', mode: 'lines+markers', fill: 'tozeroy',
            line: {color: '#8b5cf6', width: 3}
        }], { margin: {t:10} }, config);
    }
}
</script>
</body>
</html>
